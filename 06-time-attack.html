<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Time Attack - Building Games with DragonRuby</title>
        <!-- Custom HTML head -->
<meta property="og:title" content="Time Attack | Building Games with DragonRuby">
<meta property="og:type" content="book" />
<meta property="og:image" content="https://book.dragonriders.community/img/cover.jpg" />
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image:alt" content="Cover with red dragon icon and white background, which reads 'Building Games with DragonRuby: a comprehensive guide to shipping cross-platform guides with ease by Brett Chalupa and the Dragon Riders community'">

        <meta name="description" content="A free book about making 2D games with DragonRuby Game Toolkit.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="01-hello-dragon.html"><strong aria-hidden="true">1.</strong> Hello Dragon!</a></li><li class="chapter-item expanded "><a href="02-player-movement.html"><strong aria-hidden="true">2.</strong> Player Movement</a></li><li class="chapter-item expanded "><a href="03-spit-fire.html"><strong aria-hidden="true">3.</strong> Spit Fire</a></li><li class="chapter-item expanded "><a href="04-target-practice.html"><strong aria-hidden="true">4.</strong> Target Practice</a></li><li class="chapter-item expanded "><a href="05-fireball-clean-up.html"><strong aria-hidden="true">5.</strong> Fireball Clean Up</a></li><li class="chapter-item expanded "><a href="06-time-attack.html" class="active"><strong aria-hidden="true">6.</strong> Time Attack</a></li><li class="chapter-item expanded "><a href="07-high-score.html"><strong aria-hidden="true">7.</strong> High-Score</a></li><li class="chapter-item expanded "><a href="08-sound.html"><strong aria-hidden="true">8.</strong> Sound</a></li><li class="chapter-item expanded "><a href="09-background.html"><strong aria-hidden="true">9.</strong> Background</a></li><li class="chapter-item expanded "><a href="10-animation.html"><strong aria-hidden="true">10.</strong> Animation</a></li><li class="chapter-item expanded "><a href="11-scenes.html"><strong aria-hidden="true">11.</strong> Scenes</a></li><li class="chapter-item expanded "><a href="12-ship-it.html"><strong aria-hidden="true">12.</strong> Ship It!</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="outro.html">Outro</a></li><li class="chapter-item expanded affix "><a href="ruby-primer.html">Ruby Primer</a></li><li class="chapter-item expanded affix "><a href="beyond-the-code.html">Beyond the Code</a></li><li class="chapter-item expanded affix "><a href="dragonruby-resources.html">DragonRuby Resources</a></li><li class="chapter-item expanded affix "><a href="game-dev-resources.html">Game Dev Resources</a></li><li class="chapter-item expanded affix "><a href="source-control.html">Source Control</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Building Games with DragonRuby</h1>

                    <div class="right-buttons">
                        <a href="https://github.com/DragonRidersUnite/book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="time-attack"><a class="header" href="#time-attack">Time Attack</a></h1>
<p>We've <em>almost</em> got a game. But we need some way for the game to end. A lot of game loops end with the player's character dying, where they respawn or start over again. Other game loops end when the player reaches the end of a level.</p>
<p>For our simple game, let's add a 30 second timer that counts down. The objective of our game will be to see how many targets the player can hit in that time window. Let's call our game <strong>Target Practice</strong>. Every dragon needs some practice before they head out into battle, right?</p>
<p>Adding a timer to our game introduces a few new concepts we'll build out in this chapter:</p>
<ol>
<li>Keeping track of time and displaying it</li>
<li>Stopping our game when the timer runs out</li>
<li>Displaying a Game Over screen with the score</li>
<li>Allowing the player to restart the game and play again</li>
</ol>
<h2 id="getting-it-working"><a class="header" href="#getting-it-working">Getting It Working</a></h2>
<p>We'll start by introducing <code>args.state.timer</code> that will be used to keep track of how much time remains.</p>
<pre><code class="language-ruby">  args.state.score ||= 0
  args.state.timer ||= 30 * 60

  args.state.timer -= 1
</code></pre>
<p>We lazily set it to <code>30 * 60</code>. We want the game to last thirty seconds and our <code>#tick</code> method runs sixty times every second, so we multiple them together to get the total number of ticks our timer will run for. We'll then subtract one from <code>args.state.timer</code> every <code>#tick</code> so that it decreases as we play our game.</p>
<p>Right below decreasing our <code>args.state.timer</code> by one, we check to see if the timer is less than zero. If it is, that means game over.</p>
<pre><code class="language-ruby">  args.state.timer -= 1

  if args.state.timer &lt; 0
    labels = []
    labels &lt;&lt; {
      x: 40,
      y: args.grid.h - 40,
      text: &quot;Game Over!&quot;,
      size_enum: 10,
    }
    labels &lt;&lt; {
      x: 40,
      y: args.grid.h - 90,
      text: &quot;Score: #{args.state.score}&quot;,
      size_enum: 4,
    }
    labels &lt;&lt; {
      x: 40,
      y: args.grid.h - 132,
      text: &quot;Fire to restart&quot;,
      size_enum: 2,
    }
    args.outputs.labels &lt;&lt; labels

    if args.inputs.keyboard.key_down.z ||
        args.inputs.keyboard.key_down.j ||
        args.inputs.controller_one.key_down.a
      $gtk.reset
    end

    return
  end
</code></pre>
<p>If it is game over, then we let the player know, display their final score, and tell them how to play again (by pressing the fire button). We make an array of labels which we then push into <code>args.outputs.labels</code> to efficiently render them all.</p>
<p>If any of our fire keys are pressed, the game is reset with <code>$gtk.reset</code> and the player can play again.</p>
<p>The <code>return</code> line is <em>really</em> important. It says, return out of the <code>#tick</code> method so that none of the code below runs. We don't want to have the dragon be movable or for targets to spawn when it's game over. So we eject early and only display the game over screen details.</p>
<p><img src="./img/c06-game-over.jpg" alt="game over screen showing a score of 11 with text saying 'Fire to restart'" /></p>
<p>Way at the bottom of <code>#tick</code>, let's display a label with the time remaining:</p>
<pre><code class="language-ruby">  labels = []
  labels &lt;&lt; {
    x: 40,
    y: args.grid.h - 40,
    text: &quot;Score: #{args.state.score}&quot;,
    size_enum: 4,
  }
  labels &lt;&lt; {
    x: args.grid.w - 40,
    y: args.grid.h - 40,
    text: &quot;Time Left: #{(args.state.timer / 60).round}&quot;,
    size_enum: 2,
    alignment_enum: 2,
  }
  args.outputs.labels &lt;&lt; labels
</code></pre>
<p>We use the same pattern of creating a <code>labels</code> array, pushing in the player's score and the time remaining. In order to get the time remaining, we divide it by 60 and round. We do the opposite of what we did when we set the total time in ticks.</p>
<p>The <code>alignment_enum</code> let's us specify that we want the text to be right aligned instead of the default left alignment. This let's us nicely position our timer in the upper right corner of the game.</p>
<p><img src="./img/c06-timer.jpg" alt="gameplay with Time Left reading 10 seconds" /></p>
<p>We've got ourselves a game that we can start, finish, and replay. Isn't that pretty awesome?</p>
<h2 id="restart-grace-period"><a class="header" href="#restart-grace-period">Restart Grace Period</a></h2>
<p>If you happen to press the fire button right when the timer runs out, you may restart your game without even seeing the game over screen. Let's add a little grace period between when the game is over and when we start accepting input to restart. 30 frames should be plenty and it won't even be noticeable to the player.</p>
<pre><code class="language-ruby">    if args.state.timer &lt; -30 &amp;&amp;
        (args.inputs.keyboard.key_down.z ||
        args.inputs.keyboard.key_down.j ||
        args.inputs.controller_one.key_down.a)
      $gtk.reset
    end
</code></pre>
<p>Because we keep subtracting from <code>args.state.timer</code>, we can check to see if the current value is less than -30. If it is, then we'll accept input to restart the game.</p>
<p><code>&amp;&amp;</code> (double ampersand, often read as &quot;and-and&quot;) means that both sides of the expression must be true for the code within the conditional to happen. In our new restart check, we combine AND and OR by saying: if the game timer is less than -30 AND any of our fire keys are down, then we reset the game. When you group together expressions in parentheses, <code>(monday? || tuesday?)</code>, it evaluates them as one express against the other checks. We care about the timer being below a certain amount AND any of the inputs being pressed.</p>
<p>Combining logic in this way for flow control is very common when making games. <code>&amp;&amp;</code> and <code>||</code> are pretty common operators in most programming languages.</p>
<h2 id="refactor"><a class="header" href="#refactor">Refactor</a></h2>
<p>Our main <code>#tick</code> method is getting a bit long in the tooth, being over 100 lines long. We've also duplicated two things: frames per second with the <code>60</code> value and checking for fire input. This is a good opportunity to refactor our code once again to make it easier to work with. Let's break up <code>#tick</code> into a series of smaller methods that we call from within it. Encapsulating our logic into smaller pieces makes it easier to work on those smaller pieces without concerning ourselves with the rest of the code.</p>
<p>How small should you make your methods? That's up to you. Use your best judgment and do what feels right. Code can change and grow quite organically. Once something feels too big or complex or is duplicated, improve it. Don't over-engineer your game right from the start, otherwise you'll be off in the weeds and not actually making your game fun. On the other hand, if you just neglect your code, you'll make it more difficult to change, thus slowing down the development process. There's a fine line between over-engineering and creating a mess.</p>
<p>Here's the entire game broken down into some smaller methods to make it easier to work with moving forward:</p>
<pre><code class="language-ruby">FPS = 60

def spawn_target(args)
  size = 64
  {
    x: rand(args.grid.w * 0.4) + args.grid.w * 0.6,
    y: rand(args.grid.h - size * 2) + size,
    w: size,
    h: size,
    path: 'sprites/target.png',
  }
end

def fire_input?(args)
  args.inputs.keyboard.key_down.z ||
    args.inputs.keyboard.key_down.j ||
    args.inputs.controller_one.key_down.a
end

def handle_player_movement(args)
  if args.inputs.left
    args.state.player.x -= args.state.player.speed
  elsif args.inputs.right
    args.state.player.x += args.state.player.speed
  end

  if args.inputs.up
    args.state.player.y += args.state.player.speed
  elsif args.inputs.down
    args.state.player.y -= args.state.player.speed
  end

  if args.state.player.x +  args.state.player.w &gt; args.grid.w
    args.state.player.x = args.grid.w - args.state.player.w
  end

  if args.state.player.x &lt; 0
    args.state.player.x = 0
  end

  if args.state.player.y + args.state.player.h &gt; args.grid.h
    args.state.player.y = args.grid.h - args.state.player.h
  end

  if args.state.player.y &lt; 0
    args.state.player.y = 0
  end
end

def game_over_tick(args)
  labels = []
  labels &lt;&lt; {
    x: 40,
    y: args.grid.h - 40,
    text: &quot;Game Over!&quot;,
    size_enum: 10,
  }
  labels &lt;&lt; {
    x: 40,
    y: args.grid.h - 90,
    text: &quot;Score: #{args.state.score}&quot;,
    size_enum: 4,
  }
  labels &lt;&lt; {
    x: 40,
    y: args.grid.h - 132,
    text: &quot;Fire to restart&quot;,
    size_enum: 2,
  }
  args.outputs.labels &lt;&lt; labels

  if args.state.timer &lt; -30 &amp;&amp; fire_input?(args)
    $gtk.reset
  end
end

def tick args
  args.state.player ||= {
    x: 120,
    y: 280,
    w: 100,
    h: 80,
    speed: 12,
    path: 'sprites/misc/dragon-0.png',
  }
  args.state.fireballs ||= []
  args.state.targets ||= [
    spawn_target(args), spawn_target(args), spawn_target(args)
  ]
  args.state.score ||= 0
  args.state.timer ||= 30 * FPS

  args.state.timer -= 1

  if args.state.timer &lt; 0
    game_over_tick(args)
    return
  end

  handle_player_movement(args)

  if fire_input?(args)
    args.state.fireballs &lt;&lt; {
      x: args.state.player.x + args.state.player.w - 12,
      y: args.state.player.y + 10,
      w: 32,
      h: 32,
      path: 'sprites/fireball.png',
    }
  end

  args.state.fireballs.each do |fireball|
    fireball.x += args.state.player.speed + 2

    if fireball.x &gt; args.grid.w
      fireball.dead = true
      next
    end

    args.state.targets.each do |target|
      if args.geometry.intersect_rect?(target, fireball)
        target.dead = true
        fireball.dead = true
        args.state.score += 1
        args.state.targets &lt;&lt; spawn_target(args)
      end
    end
  end

  args.state.targets.reject! { |t| t.dead }
  args.state.fireballs.reject! { |f| f.dead }

  args.outputs.sprites &lt;&lt; [args.state.player, args.state.fireballs, args.state.targets]

  labels = []
  labels &lt;&lt; {
    x: 40,
    y: args.grid.h - 40,
    text: &quot;Score: #{args.state.score}&quot;,
    size_enum: 4,
  }
  labels &lt;&lt; {
    x: args.grid.w - 40,
    y: args.grid.h - 40,
    text: &quot;Time Left: #{(args.state.timer / FPS).round}&quot;,
    size_enum: 2,
    alignment_enum: 2,
  }
  args.outputs.labels &lt;&lt; labels
end

$gtk.reset
</code></pre>
<p>Because so much has changed and shifted around, I'll just walk through the main changes:</p>
<ul>
<li><code>FPS</code> is a constant, which is a special value in Ruby that doesn't change. We assign it to <code>60</code> because our game runs at sixty (f)rames (p)er (s)econd. That value won't change, but it's more helpful in our math code to see <code>FPS</code> rather than <code>60</code> because we now know what that value represents.</li>
<li><code>#fire_input?</code> checks to see if any of our keys are down for firing a fireball. By using our method, we can easily adjust it without having to change it for both restarting the game and the dragon spitting the fireball.</li>
<li><code>#handle_player_movement</code> does just what it describes. That code has a lot of checks but we haven't changed much, so let's put it in a method to get it out of the way.</li>
<li><code>#game_over_tick</code> is our own special method for when it's game over that gets called from our main <code>#tick</code>. It makes it easier to refer to and change what happens when our game is over.</li>
</ul>
<p>I hear you over there screaming, &quot;You expect me to rewrite the entire game line-by-line?!?! I quit!&quot; It's okay to copy and paste what's provided above into your game. If you've made some adjustments, make them again. This refactored code is going to be the foundation for the rest of the book.</p>
<h2 id="whats-next"><a class="header" href="#whats-next">What's Next</a></h2>
<p>We've got a working game, but it's a bit... boring. Let's polish our game up by adding high-score tracking, sounds, animations, and more. We've got a working core of a fun game, and now it's time to make it a great experience.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="05-fireball-clean-up.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="07-high-score.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="05-fireball-clean-up.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="07-high-score.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script>
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>
        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
