<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Scenes - Building Games with DragonRuby</title>
        <!-- Custom HTML head -->
<meta property="og:title" content="Scenes | Building Games with DragonRuby">
<meta property="og:type" content="book" />
<meta property="og:image" content="https://book.dragonriders.community/img/cover.jpg" />
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image:alt" content="Cover with red dragon icon and white background, which reads 'Building Games with DragonRuby: a comprehensive guide to shipping cross-platform guides with ease by Brett Chalupa and the Dragon Riders community'">

        <meta name="description" content="A free book about making 2D games with DragonRuby Game Toolkit.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="01-hello-dragon.html"><strong aria-hidden="true">1.</strong> Hello Dragon!</a></li><li class="chapter-item expanded "><a href="02-player-movement.html"><strong aria-hidden="true">2.</strong> Player Movement</a></li><li class="chapter-item expanded "><a href="03-spit-fire.html"><strong aria-hidden="true">3.</strong> Spit Fire</a></li><li class="chapter-item expanded "><a href="04-target-practice.html"><strong aria-hidden="true">4.</strong> Target Practice</a></li><li class="chapter-item expanded "><a href="05-fireball-clean-up.html"><strong aria-hidden="true">5.</strong> Fireball Clean Up</a></li><li class="chapter-item expanded "><a href="06-time-attack.html"><strong aria-hidden="true">6.</strong> Time Attack</a></li><li class="chapter-item expanded "><a href="07-high-score.html"><strong aria-hidden="true">7.</strong> High-Score</a></li><li class="chapter-item expanded "><a href="08-sound.html"><strong aria-hidden="true">8.</strong> Sound</a></li><li class="chapter-item expanded "><a href="09-background.html"><strong aria-hidden="true">9.</strong> Background</a></li><li class="chapter-item expanded "><a href="10-animation.html"><strong aria-hidden="true">10.</strong> Animation</a></li><li class="chapter-item expanded "><a href="11-scenes.html" class="active"><strong aria-hidden="true">11.</strong> Scenes</a></li><li class="chapter-item expanded "><a href="12-ship-it.html"><strong aria-hidden="true">12.</strong> Ship It!</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="outro.html">Outro</a></li><li class="chapter-item expanded affix "><a href="ruby-primer.html">Ruby Primer</a></li><li class="chapter-item expanded affix "><a href="beyond-the-code.html">Beyond the Code</a></li><li class="chapter-item expanded affix "><a href="dragonruby-resources.html">DragonRuby Resources</a></li><li class="chapter-item expanded affix "><a href="game-dev-resources.html">Game Dev Resources</a></li><li class="chapter-item expanded affix "><a href="source-control.html">Source Control</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Building Games with DragonRuby</h1>

                    <div class="right-buttons">
                        <a href="https://github.com/DragonRidersUnite/book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="scenes"><a class="header" href="#scenes">Scenes</a></h1>
<p>When making a game, there are all sorts of scenes that exist, from the main menu to the actual gameplay to the pause menu. Often these scenes have different interactions than the main game. Instead of moving your character around the world you instead move a cursor up and down menu options. In this chapter we'll refactor our main gameplay and game over state to be a bit easier to work with and then introduce a title scene that's used to start the game.</p>
<p>The concept of a &quot;scene&quot; isn't specific to DragonRuby Game Toolkit or any given game engine. It's just a generic concept that we're introducing to make our game code easier to work with. Much like a movie scene, it's clear when one ends and when one begins.</p>
<p>When we introduced the game over functionality, we actually introduced a scene separate from gameplay. Kinda neat! But it wasn't the time to think about them in terms of scenes and reckon with how we add more.</p>
<h2 id="refactor"><a class="header" href="#refactor">Refactor</a></h2>
<p>So we've got two scenes right now: gameplay (where we shoot at targets) and game over (where we display the score and allow the player to restart). Let's refactor the code to put our scenes in different methods and allow the game to switch between them given certain conditions being met.</p>
<p>Containing our scenes in methods will make it much easier to change one scene without impacting the others. It sets clear boundaries and will make our code easier to maintain.</p>
<p>We've already got <code>#game_over_tick</code>, so we can make use of that to contain the game over behavior.</p>
<p>Let's introduce a <code>#gameplay_tick</code> method that will contain the logic for our gameplay. And then we'll use <code>args.state.scene</code> to keep track of the current scene. Then if we change that value, it'll change what scene our game uses.</p>
<p>Not much of the code changes, but we do shuffle things around a bit. None of the methods above <code>#game_over_tick</code> change, so they're excluded:</p>
<pre><code class="language-ruby">HIGH_SCORE_FILE = &quot;high-score.txt&quot;
def game_over_tick(args)
  args.state.high_score ||= args.gtk.read_file(HIGH_SCORE_FILE).to_i

  args.state.timer -= 1

  if !args.state.saved_high_score &amp;&amp; args.state.score &gt; args.state.high_score
    args.gtk.write_file(HIGH_SCORE_FILE, args.state.score.to_s)
    args.state.saved_high_score = true
  end

  labels = []
  labels &lt;&lt; {
    x: 40,
    y: args.grid.h - 40,
    text: &quot;Game Over!&quot;,
    size_enum: 10,
  }
  labels &lt;&lt; {
    x: 40,
    y: args.grid.h - 90,
    text: &quot;Score: #{args.state.score}&quot;,
    size_enum: 4,
  }

  if args.state.score &gt; args.state.high_score
    labels &lt;&lt; {
      x: 260,
      y: args.grid.h - 90,
      text: &quot;New high-score!&quot;,
      size_enum: 3,
    }
  else
    labels &lt;&lt; {
      x: 260,
      y: args.grid.h - 90,
      text: &quot;Score to beat: #{args.state.high_score}&quot;,
      size_enum: 3,
    }
  end

  labels &lt;&lt; {
    x: 40,
    y: args.grid.h - 132,
    text: &quot;Fire to restart&quot;,
    size_enum: 2,
  }
  args.outputs.labels &lt;&lt; labels

  if args.state.timer &lt; -30 &amp;&amp; fire_input?(args)
    $gtk.reset
  end
end

def gameplay_tick(args)
  args.outputs.solids &lt;&lt; {
    x: 0,
    y: 0,
    w: args.grid.w,
    h: args.grid.h,
    r: 92,
    g: 120,
    b: 230,
  }

  args.state.player ||= {
    x: 120,
    y: 280,
    w: 100,
    h: 80,
    speed: 12,
  }

  player_sprite_index = 0.frame_index(count: 6, hold_for: 8, repeat: true)
  args.state.player.path = &quot;sprites/misc/dragon-#{player_sprite_index}.png&quot;

  args.state.fireballs ||= []
  args.state.targets ||= [
    spawn_target(args), spawn_target(args), spawn_target(args)
  ]
  args.state.score ||= 0
  args.state.timer ||= 30 * FPS

  args.state.timer -= 1

  if args.state.timer == 0
    args.audio[:music].paused = true
    args.outputs.sounds &lt;&lt; &quot;sounds/game-over.wav&quot;
    args.state.scene = &quot;game_over&quot;
    return
  end

  handle_player_movement(args)

  if fire_input?(args)
    args.outputs.sounds &lt;&lt; &quot;sounds/fireball.wav&quot;
    args.state.fireballs &lt;&lt; {
      x: args.state.player.x + args.state.player.w - 12,
      y: args.state.player.y + 10,
      w: 32,
      h: 32,
      path: 'sprites/fireball.png',
    }
  end

  args.state.fireballs.each do |fireball|
    fireball.x += args.state.player.speed + 2

    if fireball.x &gt; args.grid.w
      fireball.dead = true
      next
    end

    args.state.targets.each do |target|
      if args.geometry.intersect_rect?(target, fireball)
        args.outputs.sounds &lt;&lt; &quot;sounds/target.wav&quot;
        target.dead = true
        fireball.dead = true
        args.state.score += 1
        args.state.targets &lt;&lt; spawn_target(args)
      end
    end
  end

  args.state.targets.reject! { |t| t.dead }
  args.state.fireballs.reject! { |f| f.dead }

  args.outputs.sprites &lt;&lt; [args.state.player, args.state.fireballs, args.state.targets]

  labels = []
  labels &lt;&lt; {
    x: 40,
    y: args.grid.h - 40,
    text: &quot;Score: #{args.state.score}&quot;,
    size_enum: 4,
  }
  labels &lt;&lt; {
    x: args.grid.w - 40,
    y: args.grid.h - 40,
    text: &quot;Time Left: #{(args.state.timer / FPS).round}&quot;,
    size_enum: 2,
    alignment_enum: 2,
  }
  args.outputs.labels &lt;&lt; labels
end

def tick args
  if args.state.tick_count == 1
    args.audio[:music] = { input: &quot;sounds/flight.ogg&quot;, looping: true }
  end

  args.state.scene ||= &quot;gameplay&quot;

  send(&quot;#{args.state.scene}_tick&quot;, args)
end
</code></pre>
<p><code>#game_over_tick</code> is the same except for the addition of:</p>
<pre><code class="language-ruby">args.state.timer -= 1
</code></pre>
<p>We need to continue to subtract from the timer in each tick since we rely upon it for when we accept input to restart the game.</p>
<p>We introduce <code>#gameplay_tick</code> which contains all of our logic for when we're actually playing the game. We set the background to the blue solid rectangle and initialize our player and animate the sprite. That's all the same.</p>
<p>But when the timer is <code>0</code>, after we pause the music and play the game over sound, we set <code>args.state.scene</code> to <code>&quot;game_over&quot;</code> and return early. This effectively changes the scene.</p>
<p>We continue to handle input and display the gameplay sprites and labels in <code>#gameplay_tick</code>.</p>
<p>Then, finally, <code>#tick</code> has been drastically simplified. It no longer needs to be responsible for so much. It can instead just handle three things:</p>
<ol>
<li>starting the music for the game</li>
<li>Lazily initializing the scene to start with (in our case, <code>&quot;gameplay&quot;</code>)</li>
<li>Calling the proper scene tick method and passing in <code>args</code></li>
</ol>
<p>The third item there is the new part of this chapter. <code>#send</code> is a method in Ruby that allows a method to be called by passing in the name of the method as the first parameter. This is really powerful! We use string interpolation to take the value set in <code>args.state.scene</code> and append it with <code>_tick</code>. Our game then calls that method and passes in <code>args</code> as the first parameter to the called method. So if <code>args.state.scene</code> is set to <code>&quot;gameplay&quot;</code>, the <code>#gameplay_tick</code> method gets called. If it's set to <code>&quot;game_over&quot;</code>, then <code>#game_over_tick</code> gets called. If it's set to <code>&quot;credits&quot;</code>, then <code>#credits_tick</code> would get called.</p>
<p>The various scene tick methods <em>need</em> to exist in order for changing <code>args.state.scene</code> to work. But that's quite simple to do, we just introduce a new method and set <code>args.state.scene</code> to change between scenes.</p>
<h2 id="title-scene"><a class="header" href="#title-scene">Title Scene</a></h2>
<p>When players launch our game, they get dropped right into the gameplay. This can be a bit jarring, so let's introduce a new scene that displays the title of the game, controls, and lets them press a button to start.</p>
<p>In our game code, let's introduce <code>#title_tick</code> that takes <code>args</code> as its only parameter, just like our other <code>*_tick</code> methods for our scenes. In <code>#title_tick</code>, we'll render some labels and look for input to start our game. If the fireball input is pressed, we'll play a sound effect, change the scene, and return early so we can move on to the next scene.</p>
<pre><code class="language-ruby">def title_tick args
  if fire_input?(args)
    args.outputs.sounds &lt;&lt; &quot;sounds/game-over.wav&quot;
    args.state.scene = &quot;gameplay&quot;
    return
  end

  labels = []
  labels &lt;&lt; {
    x: 40,
    y: args.grid.h - 40,
    text: &quot;Target Practice&quot;,
    size_enum: 6,
  }
  labels &lt;&lt; {
    x: 40,
    y: args.grid.h - 88,
    text: &quot;Hit the targets!&quot;,
  }
  labels &lt;&lt; {
    x: 40,
    y: args.grid.h - 120,
    text: &quot;by YOU&quot;,
  }
  labels &lt;&lt; {
    x: 40,
    y: 120,
    text: &quot;Arrows or WASD to move | Z or J to fire | gamepad works too&quot;,
  }
  labels &lt;&lt; {
    x: 40,
    y: 80,
    text: &quot;Fire to start&quot;,
    size_enum: 2,
  }
  args.outputs.labels &lt;&lt; labels
end
</code></pre>
<p>Replace <code>YOU</code> with your name since you made it. It's important to take credit for your work.</p>
<p>Then in <code>#tick</code> lazily initialize <code>args.state.scene</code> to now be <code>&quot;title&quot;</code>:</p>
<pre><code class="language-ruby">def tick args
  if args.state.tick_count == 1
    args.audio[:music] = { input: &quot;sounds/flight.ogg&quot;, looping: true }
  end

  args.state.scene ||= &quot;title&quot;

  send(&quot;#{args.state.scene}_tick&quot;, args)
end
</code></pre>
<p>Now when you start the game, the title scene will be displayed:</p>
<p><img src="./img/c11-title.jpg" alt="black text on gray background that reads 'Target Practice' with instructions on how to play" /></p>
<p>When you press the fire button, the game will start. And when you restart after game over, you'll end up back on the title scene.</p>
<h2 id="extra-credit"><a class="header" href="#extra-credit">Extra Credit</a></h2>
<ul>
<li>Display a label with the current high score in the title scene so players know what to aim for.</li>
<li>Display the dragon sprite in the title scene to give a player a taste of what they can expect.</li>
<li>How could you make it so that the music doesn't start until gameplay starts? Or play different music during the title scene?</li>
<li>Restarting the game back on the title scene may not be ideal. How would you change it so that restarting the game automatically goes to the <code>gameplay</code> scene?</li>
<li>Allow players to pause the game while in the middle of the gameplay scene.</li>
</ul>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>We've now got three scenes in our game and can easily switch between them. The code for each scene is contained within its own method, making it easier to change a given scene without accidentally changing the others. Adding another scene to our game, like a pause menu, wouldn't be very complicated.</p>
<h2 id="whats-next"><a class="header" href="#whats-next">What's Next</a></h2>
<p>For all intents and purposes our game is done! You can start it, play it, and replay it. All that's left to do is release it so that the world (or at the very least our friends) can play it.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="10-animation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="12-ship-it.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="10-animation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="12-ship-it.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script>
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>
        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
